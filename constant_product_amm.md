# Constant Product AMMs

Following on from yesterday's AMM discussion, here's my understanding of how a "constant product" automated liquidity protocol, such as those found on Uniswap, works. Warning, this may not be entirely correct, I'm no expert, and it is definitely a simplification - for instance, I haven't talked much about fees, which are important, particularly to the liquidity providers, and I'm ignoring rounding errors. [But some additional notes that aren't essential for the main thread are in square brackets]. All corrections or other suggestions for improvement welcomed.

Lets say we are trading a pair of ERC-20 tokens A and B. There is a liquidity pool, a collection of tokens of the two types, A and B. This is set up so that there are approximately equal (in dollar equivalent) amounts of each. So if an A currently trades for 10 B the pool will contain approximately 10 times as many B tokens as A tokens. There are two types of transactions that can add or remove tokens from the pool. The first is normal trading where someone has tokens of type A that they wish to exchange for tokens of type B - or the other way around, trading B for A. The second type of transaction is where liquidity providers add or withdraw liquidity. These two types work in very different ways...

## Normal trading

Normal trading is at a rate determined by the AMM contract. For a constant product protocol the exchange rate you get is whatever is needed to keep constant the product of the number of A tokens and the number of B tokens in the pool. Note, these are the actual numbers of tokens, not their dollar equivalent values. So say the pool currently holds one thousand A tokens and ten thousand B tokens. The product of these numbers is ten million. Now I come along with a hundred A tokens that I wish to trade for B tokens. The number of B I get for my hundred A is calculated as follows.

Number of A in pool after my trade: 1,000 + 100 = 1,100 (number of A in pool beforehand, plus the number I added)  
Number of B in pool after my trade: 10,000 - x (number of B in pool beforehand, minus x, the number I received in exchange for my hundred A)

We want the product of these numbers to still be ten million, as it was before my trade. So we have

	1,100 * (10,000 - x) = 10,000,000  
	x = 10,000 - 10,000,000/1,100 ~= 909.91

So I trade my 100 A, for which I get 909.91 B. I do not get 1,000 B as I might have expected given the starting exchange rate of 10 to 1, this is the slippage. The numbers of tokens in the pool after this are A: 1,100; B: 9,090.91 and the product of these numbers is still ten million. [In reality I would get a bit less than this, because Uniswap would also charge me a fee.] This is an extreme example because my trade of 100 A involves quite a large percentage (~10%) of the total number of A in the pool. Normally you would be trading a much smaller amount relative to the pool size, resulting in much less slippage.

If someone else comes straight after me with another 100 A to trade they will get a worse deal than I did, simply because my transaction just happened [and so the possibility of front running arises]. For them the figures are 

Number of A in pool after their trade: 1,100 + 100 = 1,200 (number of A in pool beforehand, plus the number they added)  
Number of B in pool after their trade: 9,090.91 - x (number of B in pool beforehand, minus x, the number they received in exchange for their hundred A)  

We want the product of these numbers to still be ten million. So we have

	1,200 * (9,090.91 - x) = 10,000,000  
	x = 9,090.91 - 10,000,000/1,200 ~= 757.58  

They only get 757.58 B for their 100 A and the numbers in the pool are now A: 1,200; B: 8,333.33 whose product is still one million [ignoring rounding error, in reality we would be working to 18 decimal places, not 2]

As long as people keep only swapping A for B the exchange rate keeps moving in the same direction, towards fewer B for your A. Of course if you are wanting to trade B for A this is in your favour, you will get more A for your B, and when you do so your trade will move the rate back a little in the other direction. Note that all of this logic is determined solely by the trading on this AMM and the contents of its liquidity pool. Any other trading that might be taking place on some other exchange, Coinbase or SushiSwap etc., does not directly affect it. However if as a result the exchange rate of A for B starts to differ from that on some other exchange, this creates an arbitrage opportunity for someone [or some bot]. A large movement of A into, and correspondingly B out of, the liquidity pool will tend to be cancelled out by someone selling A for B on another exchange, where they get more B for their A, and then selling that B for A here, where they receive more A for their B than it originally cost them to buy it. This nets them a profit and re-balances the pool. It will continue until the exchange rates are approximately matched [when the difference becomes small, transaction and gas fees will eat all the profits in such trading].

## Liquidity providers

When liquidity providers add liquidity they must deposit, or stake as it's called, an approximately equal dollar equivalent value of A and B. So if an A is worth ten B they must stake one A and ten B, or twenty A and two hundred B, etc. Unlike normal trading, adding or removing liquidity will change the product of the number of A and the number of B in the pool. Let's say the pool has one thousand A and ten thousand B, so the product is ten million. I can stake an additional two hundred A and two thousand B. After this the pool has twelve hundred A and twelve thousand B, so the product is now fourteen point four million. From that point onwards normal trading of A for B, or vice versa, will be at a rate which preserves this new product. 

Liquidity providers are rewarded with a percentage sliced off every trade made, which is distributed amongst them according to the percentage of the pool that they provided. As providers add or withdraw liquidity the percentage of the total liquidity pool currently provided by each is tracked. So if the pool contains one thousand A and ten thousand B, then I stake a further one thousand A and ten thousand B, I have provided fifty percent of the liquidity pool and will get half of all the liquidity provider fees. If someone else stakes a further one thousand A and ten thousand B then we have each provided one third of the pool and will each get one third of the fees, and so on.

It is important that each liquidity provider is entitled to a percentage of the liquidity pool, not to exactly what they originally put in. In the above example the exchange rate stayed constant at one A for ten B. This is the ideal situation for a liquidity provider, I can collect my fees for as long as I stake, then I can withdraw my third of the liquidity pool and get back wheat I put in, one thousand A and ten thousand B. In reality however, the exchange rate is likely to change over the time I am staking. This affects what I get back and can lead to a phenomanon known [inexplicably] as "impermanent loss". 

To see this we need to consider dollar equivalent values of the staked coins. Let's say at the start that an A is worth around ten dollars and a B around one dollar, hence the ten to one exchange rate. Now I stake my one thousand A and ten thousand B, so I have staked ten thousand dollars worth of each, a total stake of twenty thousand dollars worth of coins. Next comes something I didn't plan for: Elon Musk gets bored and starts tweeting about B. As a result there's a massive surge of interest, everyone and their dog wants to buy B. This causes the price of B on Coinbase and all other exchanges to shoot up, pretty soon one B costs a hundred dollars. Meanwhile nothing much changes for coin A, it's still trading for ten dollars. As this is happening our AMM will feel the effects. Initially it allows you to trade one A, which will cost you ten dollars on Coinbase or elsewhere, for ten B. As the value of B starts to shoot up, people [and bots] will be flooding in to sell A for B and make a killing. The fixed product algorithm responds to this by adjusting the exchange rate, the more A comes in and B goes out the fewer B it will give for your A. We quickly reach the point where our AMM gives one tenth of a B for one A, matching the new market prices of one hundred dollars for B and ten dollars for A.

Now I decide to cash in and withdraw my liquidity. I provided half of the liquidity, so I get back half of the pool. What I put in was one thousand A and ten thousand B, but that's not what I get back. As a result of the massive price swing, people have been trading A for B until the exchange rate fell from ten B for an A to one tenth of a B for an A. Consequently there's a lot more A, and a lot less B, in the pool now. Assuming that nobody else has added or withdrawn liquidity, the constant product our AMM is working with is still two thousand (the number of A in the pool immediately after I staked mine) times twenty thousand (the number of B in the pool immediately after I staked mine), which is forty million. Now however the pool contains twenty thousand A and two thousand B, reflecting the new ratio of their values. So I get back half of that, which is ten thousand A, worth one hundred thousand dollars, and one thousand B, also worth one hundred thousand dollars. So from my initial stake of twenty thousand dollars worth of coins I get back two hundred thousand dollars worth of coins, which is on top of the transaction fees I received whilst staking. Am I happy? Well that depends on how I look at it (and do bear in mind that money, I am reliably informed, can't buy happiness anyway). One way I could look at it is to see that if I'd just held on to my original stake and done nothing with it, then I would still have one thousand A (still worth ten thousand dollars) and ten thousand B (now worth one million dollars). So by staking it I have actually ended up the best part of eight hundred thousand dollars worse off than I could have been by doing nothing! That's impermanent loss. It's an odd name, firstly because it is permanent - I can't go back and change my mind - and, secondly because it's not necessarily a loss - in this example I made a lot of money, it's just that, with hindsight, I could have made far more.

In a nutshell the problem is that when the relative values of the two tokens you are providing liquidity for change, then your stake gets adjusted in the opposite direction to what you'd like. You always end up with more of the coin that's become relatively less valuable, and less of the one that's become relatively more valuable. The best case is that their relative values don't change much, so you get back roughly what you put in. So why provide liquidity at all? That's for the transaction fees you get whilst staking, when all goes well these can give a return on capital far above what's available from most conventional investments.